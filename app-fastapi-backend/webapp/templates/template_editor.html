{% extends "base.html" %}

{% block title %}Editor de Plantilla - CobraFlow{% endblock %}

{% block content %}
<!-- Intro.js CSS -->
<link rel="stylesheet" href="https://unpkg.com/intro.js/introjs.css">

<style>
    :root {
        --primary-color: #262627;
        --secondary-color: #9B7FB8;
    }
    .introjs-button.introjs-nextbutton {
        color: white !important;
    }
    .introjs-skipbutton {
    color: #718096;
    top: 20px;
    right: 30px;
    font-size: 1.2em;
}

    .editor-wrapper {
        min-height: 100vh;
        background: #f5f5f5;
        padding: 2rem 1rem;
    }

    .editor-container {
        max-width: 1600px;
        margin: 0 auto;
    }

    .editor-header {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .editor-header h1 {
        font-size: 2rem;
        font-weight: 700;
        color: #1a202c;
        margin: 0 0 0.5rem 0;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .editor-header h1::before {
        content: "‚úèÔ∏è";
        font-size: 2rem;
    }

    .editor-subtitle {
        color: #718096;
        margin: 0;
    }

    .editor-layout {
        display: grid;
        grid-template-columns: 400px 1fr;
        gap: 2rem;
        align-items: start;
    }

    /* Panel de controles */
    .controls-panel {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        max-height: 100%;
        overflow-y: auto;
        position: sticky;
        top: 2rem;
    }

    .controls-panel h3 {
        font-size: 1.25rem;
        font-weight: 600;
        color: #2d3748;
        margin: 0 0 1.5rem 0;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid #e2e8f0;
    }

    .control-section {
        margin-bottom: 2rem;
    }

    .control-section h4 {
        font-size: 1rem;
        font-weight: 600;
        color: #4a5568;
        margin: 0 0 1rem 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .control-group {
        margin-bottom: 1.5rem;
    }

    .control-group label {
        display: block;
        font-weight: 600;
        color: #4a5568;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }

    .color-control {
        display: flex;
        gap: 0.75rem;
        align-items: center;
    }

    .color-control input[type="color"] {
        width: 60px;
        height: 45px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        cursor: pointer;
    }

    .color-control input[type="text"] {
        flex: 1;
        padding: 0.75rem;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 0.95rem;
    }

    /* Preview panel */
    .preview-panel {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .preview-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #e2e8f0;
    }

    .preview-header h3 {
        font-size: 1.25rem;
        font-weight: 600;
        color: #2d3748;
        margin: 0;
    }

    .preview-actions {
        display: flex;
        gap: 0.75rem;
    }

    /* ========== DOCUMENTO - Dise√±o Turquesa Moderno ========== */
    .template-preview {
        width: min(210mm, 100%);
        min-height: 297mm;
        margin: 0 auto;
        background: #ffffff;
        border: none;
        border-radius: 0;
        padding: 0;
        position: relative;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
        color: #333;
        line-height: 1.6;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }

    .doc-foreground {
        position: relative;
        z-index: 1;
        min-height: 297mm;
        display: flex;
        flex-direction: column;
    }

    /* Header turquesa superior */
    .template-header {
        background: linear-gradient(135deg, #4ECDC4 0%, #44A9A3 100%);
        height: 80px;
        margin: 0;
        padding: 0;
        border: none;
    }

    /* Logo y nombre de empresa */
    .doc-brand {
        text-align: center;
        padding: 10px;
    }

    .template-logo {
        display: none;
    }

    .template-company {
        font-size: 32px;
        font-weight: 700;
        color: #4ECDC4;
        letter-spacing: 2px;
        margin: 0;
        padding: 0;
    }

    /* T√≠tulo principal - Cuenta de Cobro */
    .main-title-wrapper {
        text-align: center;
        margin: 20px 0;
    }

    .template-subtitle {
        font-size: 24px;
        color: #4ECDC4;
        font-weight: 600;
        margin: 0;
        position: relative;
        display: inline-block;
        padding-bottom: 10px;
    }

    .template-subtitle:after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, transparent, #4ECDC4, transparent);
    }

    .doc-body {
        padding: 0 50px 40px;
        flex: 1;
    }


    .contact-info-section {
    color: #55e9df;
    font-size: 14px;
    margin-bottom: 25px;
    line-height: 1.8;
    display: flex;
    flex-direction: row;
    align-content: center;
    justify-content: center;
    background-color: #fffafa;
    font-weight: 600;
    
}

    .contact-info-section p {
        margin: 2px 0;
    }

    /* Secci√≥n de informaci√≥n del emisor y cliente */
    .template-info {
        display: block;
        margin-bottom: 25px;
        font-size: 14px;
        line-height: 1.9;
    }

    .info-box {
        padding: 0;
        background: transparent;
        border: 0;
        margin-bottom: 15px;
    }

    .info-box h4 {
        font-weight: 700;
        color: #333;
        margin: 0 0 10px 0;
        font-size: 14px;
    }

    .info-box p {
        margin: 5px 0;
        font-size: 14px;
        color: #666;
    }

    .info-box p strong {
        color: #333;
        font-weight: 600;
        min-width: 120px;
        display: inline-block;
    }

    /* Tabla de servicios moderna */
    .template-table {
        width: 100%;
        border-collapse: collapse;
        margin: 8px 0;
        box-shadow: rgba(0, 0, 0, 0.02) 0px 1px 3px 0px, rgba(27, 31, 35, 0.15) 0px 0px 0px 1px;
        border: none;
    }

    .template-table thead {
        background: linear-gradient(135deg, #818181 0%, #44A9A3 100%);
        color: white;
    }

    .template-table th {
        padding:10px;
        text-align: left;
        font-weight: 600;
        font-size: 13px;
        letter-spacing: 0.5px;
        border: none;
    }

    .template-table th:nth-child(3),
    .template-table th:nth-child(4),
    .template-table th:nth-child(5) {
        text-align: right;
    }

    .template-table tbody tr {
        border-bottom: 1px solid #e0e0e0;
        transition: background 0.2s;
    }

    .template-table tbody tr:hover {
        background: #f9f9f9;
    }

    .template-table td {
        padding: 10px;
        font-size: 14px;
        color: #555;
        border: none;
    }

    /* Total destacado */
    .template-total {
    text-align: right;
    margin-top: 0;
    padding: 15px;
    background: #f5f5f5;
    font-weight: 700;
    border-radius: 10px;
    border: solid 1px #bfbfbf;
}

    .total-label {
        font-size: 15px;
        font-weight: 700;
        margin-right: 15px;
        color: #333;
    }

    .total-amount {
        font-size: 18px;
        font-weight: 700;
        color: #4ECDC4;
    }

    /* Secci√≥n de pago */
    .payment-section {
        margin: 25px 0;
        font-size: 14px;
    }

    .payment-section h4 {
        font-weight: 700;
        color: #333;
        margin-bottom: 10px;
        font-size: 14px;
    }

    .payment-section p {
        color: #666;
        line-height: 1.8;
        margin: 5px 0;
    }

    /* Secci√≥n de notas */
    .notes-section {
        margin: 25px 0;
        font-size: 14px;
    }

    .notes-section h4 {
        font-weight: 700;
        color: #333;
        margin-bottom: 10px;
        font-size: 14px;
    }

    /* Footer con dise√±o diagonal */
    .template-footer {
        position: relative;
        height: 80px;
        margin-top: auto;
        overflow: hidden;
        border: none;
        padding: 0;
    }

    .template-footer:before {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 40%;
        height: 100%;
        background: var(--secondary-color);
        clip-path: polygon(0 0, 100% 100%, 0 100%);
        transition: background 0.3s ease;
    }

    .template-footer:after {
        content: '';
        position: absolute;
        bottom: 0;
        right: 0;
        width: 70%;
        height: 100%;
        background: var(--primary-color);
        clip-path: polygon(15% 0, 100% 0, 100% 100%, 0 100%);
        transition: background 0.3s ease;
    }

    /* Contenteditable styling */
    [contenteditable="true"] {
        outline: none;
        transition: .4s;
        border-radius: 4px;
        position: relative;
        padding: 3px 8px;

    }

    #cliente-nit, #cliente-nombre{
        transition: .4s;
    }


    #cliente-nit:hover, #cliente-nombre:hover, #project-description:hover {
        background: rgb(255, 255, 255);
        box-shadow: rgba(100, 100, 111, 0.2) 0px 7px 29px 0px;
        transform: translateY(-1px)scale(1.01) !important;
        transition: .4s;
    }

    #project-description {
       border-bottom: solid 1px #bfbfbf;
    }

    [contenteditable="true"]:hover {
        background: rgb(255, 255, 255);
        box-shadow: rgba(100, 100, 111, 0.2) 0px 7px 29px 0px;
        cursor: text;
        transform: translateY(-1px)scale(1.01);
        transition: .4s;
    }

    [contenteditable="true"]:focus {
        background: rgba(78, 205, 196, 0.08);
        box-shadow: rgba(78, 205, 196, 0.3) 0px 8px 24px;
        cursor: text;
        transform: translateY(-1px);
    }

    [contenteditable="true"]:empty:before {
        content: attr(data-placeholder);
        color: #cbd5e0;
        font-style: italic;
    }

    /* Service remove button */
    .service-remove {
        display: inline-block;
        width: 24px;
        height: 24px;
        line-height: 17px;
        text-align: center;
        border-radius: 50%;
        cursor: pointer;
        font-size: 15px;
        font-weight: bold;
        transition: all 0.2s ease;
        text-decoration: none;
    }

    .service-remove:hover {
        transform: scale(1.1);
    }

    /* Buttons */
    .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
        font-size: 0.95rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-primary {
        background: linear-gradient(135deg, #4ECDC4 0%, #44A9A3 100%);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(78, 205, 196, 0.3);
    }

    .btn-secondary {
        background: #e2e8f0;
        color: #2d3748;
    }

    .btn-secondary:hover {
        background: #cbd5e0;
    }

    .btn-success {
        background: #48bb78;
        color: white;
    }

    .btn-success:hover {
        background: #38a169;
    }

    /* Mobile responsive */
    @media (max-width: 1024px) {
        .editor-layout {
            grid-template-columns: 1fr;
        }

        .controls-panel {
            position: static;
            max-height: none;
        }
    }

    @media (max-width: 768px) {
        .editor-wrapper {
            padding: 1rem 0.5rem;
        }

        .editor-header {
            padding: 1.5rem;
        }

        .editor-header h1 {
            font-size: 1.5rem;
        }

        .preview-panel {
            padding: 1rem;
        }

        .template-preview {
            width: 100%;
        }

        .doc-body {
            padding: 0 25px 30px;
        }

        .template-company {
            font-size: 24px;
        }

        .template-subtitle {
            font-size: 18px;
        }
    }

    /* Print / PDF */
    @page {
        size: A4;
        margin: 0;
    }

    @media print {
        body {
            background: #ffffff !important;
        }

        .container {
            max-width: none !important;
            padding: 0 !important;
            margin: 0 !important;
        }

        .editor-container {
            max-width: none !important;
            margin: 0 !important;
        }

        .editor-layout {
            display: block !important;
        }

        header.main-header,
        footer.main-footer,
        .editor-header,
        .controls-panel,
        .preview-header,
        .service-remove {
            display: none !important;
        }

        .editor-wrapper,
        .preview-panel {
            padding: 0 !important;
            background: transparent !important;
            box-shadow: none !important;
            border: 0 !important;
        }

        .template-preview {
            width: 210mm !important;
            min-height: 297mm !important;
            margin: 0 !important;
            border: 0 !important;
            box-shadow: none !important;
        }

        [contenteditable="true"]:hover,
        [contenteditable="true"]:focus {
            background: transparent !important;
            box-shadow: none !important;
        }

        thead {
            display: table-header-group;
            box-shadow: rgba(0, 0, 0, 0.02) 0px 1px 3px 0px, rgba(27, 31, 35, 0.15) 0px 0px 0px 1px;
        }

        tr {
            break-inside: avoid;
            page-break-inside: avoid;
        }

        .template-table th:first-child,
        .template-table td:first-child {
            display: none !important;
        }
    }
</style>

<div class="editor-wrapper">
    <div class="editor-container">
        <!-- Header -->
        <div class="editor-header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>Editor Visual de Plantilla</h1>
                    <p class="editor-subtitle">Personaliza tu plantilla de cuenta de cobro en tiempo real</p>
                </div>
                <button class="btn btn-secondary" onclick="startTour()" style="height: fit-content;">
                    ‚ùì Tour Guiado
                </button>
            </div>
        </div>

        <div class="editor-layout">
            <!-- Controls Panel -->
            <div class="controls-panel"
                 data-intro="Aqu√≠ puedes personalizar los colores de tu plantilla y gestionar los servicios. Todos los cambios se aplican en tiempo real."
                 data-step="1">
                <h3>Controles de Personalizaci√≥n</h3>

                <!-- Colores -->
                <div class="control-section">
                    <h4>üé® Colores</h4>

                    <div class="control-group">
                        <label>Color Principal</label>
                        <div class="color-control">
                            <input type="color" id="primary-color" value="#262627" onchange="applyColors()">
                            <input type="text" id="primary-color-text" value="#262627" maxlength="7"
                                   oninput="syncColorFromText('primary')" placeholder="#262627">
                        </div>
                    </div>

                    <div class="control-group">
                        <label>Color Secundario</label>
                        <div class="color-control">
                            <input type="color" id="purple-color" value="#9B7FB8" onchange="applyColors()">
                            <input type="text" id="purple-color-text" value="#9B7FB8" maxlength="7"
                                   oninput="syncColorFromText('purple')" placeholder="#9B7FB8">
                        </div>
                    </div>
                </div>

                <!-- Tipograf√≠a -->
                <div class="control-section">
                    <h4>üìù Tipograf√≠a</h4>

                    <div class="control-group">
                        <label>Fuente del Documento</label>
                        <select id="font-family" onchange="applyFont()" style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.95rem;">
                            <option value="Arial, Helvetica, sans-serif">Arial</option>
                            <option value="'Times New Roman', Times, serif">Times New Roman</option>
                            <option value="'Courier New', Courier, monospace">Courier New</option>
                            <option value="Georgia, serif">Georgia</option>
                            <option value="Verdana, sans-serif">Verdana</option>
                            <option value="'Trebuchet MS', sans-serif">Trebuchet MS</option>
                            <option value="'Comic Sans MS', cursive">Comic Sans MS</option>
                            <option value="Impact, fantasy">Impact</option>
                            <option value="'Lucida Console', monospace">Lucida Console</option>
                            <option value="-apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif" selected>System (Recomendado)</option>
                        </select>
                    </div>
                </div>

                <!-- Instrucciones -->
                <div class="control-section" style="display: none;">
                    <div style="background: #e8f9f8; padding: 1rem; border-radius: 8px; border-left: 4px solid #4ECDC4;">
                        <h4 style="margin: 0 0 0.5rem 0; color: #4ECDC4;">üí° Modo de Edici√≥n</h4>
                        <p style="margin: 0; font-size: 0.85rem; color: #4a5568; line-height: 1.5;">
                            Haz clic directamente sobre cualquier texto del documento para editarlo en tiempo real.
                            Los cambios se aplicar√°n autom√°ticamente.
                        </p>
                    </div>
                </div>

                <!-- Tabla de servicios din√°mica -->
                <div class="control-section">
                    <h4>üìã Gesti√≥n de Servicios</h4>
                    <button class="btn btn-secondary" id="add-service-btn" style="width: 100%;" onclick="addServiceRow()"
                            data-intro="Usa este bot√≥n para agregar m√°s servicios a tu cuenta de cobro. Puedes agregar tantos como necesites."
                            data-step="5">
                        ‚ûï Agregar Servicio
                    </button>
                    <p style="font-size: 0.85rem; color: #718096; margin-top: 0.5rem;">
                        Edita directamente en la tabla del documento
                    </p>
                </div>

                <!-- Acciones -->
                <div class="control-section">
                    <button class="btn btn-primary" style="width: 100%;" onclick="saveTemplate()">
                        üíæ Guardar Plantilla
                    </button>
                    <button class="btn btn-secondary" style="width: 100%; margin-top: 0.75rem;" onclick="resetTemplate()">
                        üîÑ Restaurar Valores
                    </button>
                </div>
            </div>

            <!-- Preview Panel -->
            <div class="preview-panel">
                <div class="preview-header">
                    <h3>Vista Previa</h3>
                    <div class="preview-actions">
                        <button class="btn btn-success" onclick="downloadPDF()" title="Funci√≥n en desarrollo - Usa Ctrl+P para imprimir">
                            üìÑ Descargar PDF
                        </button>
                    </div>
                </div>

                <div class="template-preview" id="template-preview"
                     data-intro="Este es tu documento de cuenta de cobro. Puedes hacer clic en cualquier texto para editarlo directamente."
                     data-step="2">
                    <div class="doc-foreground">
                        <!-- Header turquesa -->
                        <header class="template-header" id="template-header"></header>

                        <!-- Logo/Nombre empresa -->
                        <div class="doc-brand">
                            <div class="template-company" id="template-company" contenteditable="true" data-placeholder="NOMBRE EMPRESA">COBRAFLOW</div>
                        </div>

                        <main class="doc-body">
                            <!-- T√≠tulo principal -->
                            <div class="main-title-wrapper">
                                <h1 class="template-subtitle" id="template-subtitle" contenteditable="true" data-placeholder="CUENTA DE COBRO">CUENTA DE COBRO</h1>
                            </div>
                             
                            <!-- Informaci√≥n de contacto -->
                            <div class="contact-info-section">
                                <p contenteditable="true" data-placeholder="Tel√©fono" id="contact-phone" style="border-right:solid 1px #eeeeee ;">+57 300 123 4567</p>
                                <p contenteditable="true" data-placeholder="Email" id="contact-email">contacto@cobraflow.co</p>
                                <p contenteditable="true" data-placeholder="Ciudad" id="contact-city"  style="border-left:solid 1px #eeeeee ;">Cartagena, Colombia</p>
                            </div>

                            <!-- Informaci√≥n del cliente y emisor -->
                            <section class="template-info" aria-label="Informaci√≥n del documento">
                                <div class="info-box">
                                    <h4>Informaci√≥n del Cliente</h4>
                                    <p><strong>Cliente:</strong> <span contenteditable="true" data-placeholder="Nombre del cliente" id="cliente-nombre"
                                        data-intro="Los campos como este son editables. Haz clic sobre ellos para cambiar el contenido. Ver√°s un efecto visual cuando pases el mouse."
                                        data-step="3">Empresa Cliente S.A.S</span></p>
                                    <p><strong>NIT:</strong> <span contenteditable="true" data-placeholder="NIT" id="cliente-nit">900123456-7</span></p>
                                    <p><strong>Fecha:</strong> <span id="doc-date">17/12/2025</span></p>
                                </div>

                                <div class="info-box">
                                    <h4 style="color:#8d8d8d;">Servicio / Proyecto</h4>
                                    <p contenteditable="true" data-placeholder="Descripci√≥n del servicio o proyecto" id="project-description">Consultor√≠a y desarrollo de software empresarial</p>
                                </div>
                            </section>

                            
                            <!-- Tabla de servicios -->
                            <table class="template-table" id="template-table" aria-label="Servicios"
                                   data-intro="En esta tabla puedes agregar, editar o eliminar servicios. Los totales se calculan autom√°ticamente."
                                   data-step="4">
                                <thead>
                                    <tr>
                                        <th style="width: 8%;"></th>
                                        <th style="width: 40%;">Descripci√≥n</th>
                                        <th style="text-align: center; width: 12%;">Cantidad</th>
                                        <th style="text-align: right; width: 20%;">Precio Unitario</th>
                                        <th style="text-align: right; width: 20%;">Total</th>
                                    </tr>
                                </thead>
                                <tbody id="services-tbody">
                                    <tr>
                                        <td style="text-align: center;"><a class="service-remove" onclick="removeServiceRow(this)">‚úñ</a></td>
                                        <td contenteditable="true" data-placeholder="Descripci√≥n del servicio">Consultor√≠a Empresarial</td>
                                        <td style="text-align: center;" contenteditable="true" class="quantity-cell" data-placeholder="1">1</td>
                                        <td style="text-align: right;" contenteditable="true" class="price-cell" data-prefix="$" data-placeholder="0">3,590,000</td>
                                        <td style="text-align: right;" class="total-cell"><span data-prefix>$</span><span class="row-total">3,590,000</span></td>
                                    </tr>
                                </tbody>
                            </table>

                            <!-- Total -->
                            <section class="template-total" aria-label="Total">
                                <span class="total-label">Total General</span>
                                <span class="total-amount" id="template-total">$3,590,000</span>
                            </section>

                            <!-- Informaci√≥n de pago -->
                            <div class="payment-section">
                                <h4>P√°guese A:</h4>
                                <p><strong>Nombre:</strong> <span contenteditable="true" data-placeholder="Nombre" id="payment-name">Juan P√©rez</span></p>
                                <p><strong>C√©dula:</strong> <span contenteditable="true" data-placeholder="C√©dula" id="payment-id">1234567890</span></p>
                                <p><strong>Cuenta:</strong> <span contenteditable="true" data-placeholder="Banco - Tipo - N√∫mero" id="payment-account">Bancolombia - Ahorro - 12345678901</span></p>
                            </div>

                            <!-- Nota -->
                            <div class="notes-section">
                                <h4>Nota:</h4>
                                <p contenteditable="true" data-placeholder="Nota adicional" id="note-text">Se solicita que el pago sea realizado a la mayor brevedad posible.</p>
                            </div>
                        </main>

                        <!-- Footer diagonal -->
                        <footer class="template-footer" aria-label="Footer"></footer>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // ==================== UTILITY FUNCTIONS ====================

    function formatNumber(number) {
        return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    function parseNumber(str) {
        return parseFloat(str.replace(/[^\d.-]/g, '')) || 0;
    }

    function adjustColor(color, amount) {
        const num = parseInt(color.replace("#", ""), 16);
        const r = Math.max(0, Math.min(255, (num >> 16) + amount));
        const g = Math.max(0, Math.min(255, ((num >> 8) & 0x00FF) + amount));
        const b = Math.max(0, Math.min(255, (num & 0x0000FF) + amount));
        return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
    }

    // ==================== COLOR MANAGEMENT ====================

    function syncColorFromText(type) {
        const textInput = document.getElementById(`${type}-color-text`);
        const colorInput = document.getElementById(`${type}-color`);

        let value = textInput.value.trim();
        if (value && !value.startsWith('#')) {
            value = '#' + value;
            textInput.value = value;
        }

        if (/^#[0-9A-Fa-f]{6}$/.test(value)) {
            colorInput.value = value;
            applyColors();
        }
    }

    function applyColors() {
        const primaryColor = document.getElementById('primary-color').value;
        const secondaryColor = document.getElementById('purple-color').value;

        document.getElementById('primary-color-text').value = primaryColor.toUpperCase();
        document.getElementById('purple-color-text').value = secondaryColor.toUpperCase();

        // Actualizar CSS variables
        document.documentElement.style.setProperty('--primary-color', primaryColor);
        document.documentElement.style.setProperty('--secondary-color', secondaryColor);

        // Aplicar color principal
        const header = document.getElementById('template-header');
        header.style.background = `linear-gradient(135deg, ${primaryColor} 0%, ${adjustColor(primaryColor, -20)} 100%)`;

        const companyName = document.getElementById('template-company');
        companyName.style.color = primaryColor;

        const subtitle = document.getElementById('template-subtitle');
        subtitle.style.color = primaryColor;

        const contactSection = document.querySelector('.contact-info-section');
        contactSection.style.color = primaryColor;

        const tableHeaders = document.querySelectorAll('.template-table thead');
        tableHeaders.forEach(thead => {
            thead.style.background = `linear-gradient(135deg, ${primaryColor} 0%, ${adjustColor(primaryColor, -20)} 100%)`;
        });

        document.getElementById('template-total').style.color = primaryColor;
    }

    // ==================== FONT MANAGEMENT ====================

    function applyFont() {
        const fontFamily = document.getElementById('font-family').value;
        const preview = document.getElementById('template-preview');
        preview.style.fontFamily = fontFamily;
    }

    // ==================== TABLE CALCULATIONS ====================

    function calculateRowTotal(row) {
        const quantityCell = row.querySelector('.quantity-cell');
        const priceCell = row.querySelector('.price-cell');
        const totalCell = row.querySelector('.row-total');

        if (!quantityCell || !priceCell || !totalCell) return 0;

        const quantity = parseNumber(quantityCell.textContent);
        const price = parseNumber(priceCell.textContent);
        const total = quantity * price;

        totalCell.textContent = formatNumber(total);
        return total;
    }

    function calculateGrandTotal() {
        let grandTotal = 0;
        const rows = document.querySelectorAll('#services-tbody tr');

        rows.forEach(row => {
            grandTotal += calculateRowTotal(row);
        });

        document.getElementById('template-total').textContent = '$' + formatNumber(grandTotal);
    }

    // ==================== SERVICE ROW MANAGEMENT ====================

    function addServiceRow() {
        const tbody = document.getElementById('services-tbody');
        const newRow = document.createElement('tr');

        newRow.innerHTML = `
            <td style="text-align: center;"><a class="service-remove" onclick="removeServiceRow(this)">‚úñ</a></td>
            <td contenteditable="true" data-placeholder="Descripci√≥n del servicio">Nuevo servicio</td>
            <td style="text-align: center;" contenteditable="true" class="quantity-cell" data-placeholder="1">1</td>
            <td style="text-align: right;" contenteditable="true" class="price-cell" data-prefix="$" data-placeholder="0">0</td>
            <td style="text-align: right;" class="total-cell"><span data-prefix>$</span><span class="row-total">0</span></td>
        `;

        tbody.appendChild(newRow);
        attachCellListeners(newRow);
        calculateGrandTotal();
    }

    function removeServiceRow(button) {
        const tbody = document.getElementById('services-tbody');
        const rows = tbody.querySelectorAll('tr');

        if (rows.length <= 1) {
            Swal.fire({
                icon: 'warning',
                title: 'No se puede eliminar',
                text: 'Debe haber al menos un servicio en la tabla',
                timer: 2000,
                showConfirmButton: false
            });
            return;
        }

        const row = button.closest('tr');
        row.remove();
        calculateGrandTotal();
    }

    // ==================== CONTENTEDITABLE HANDLERS ====================

    function attachCellListeners(row) {
        const quantityCell = row.querySelector('.quantity-cell');
        const priceCell = row.querySelector('.price-cell');

        if (quantityCell) {
            quantityCell.addEventListener('input', function() {
                calculateRowTotal(row);
                calculateGrandTotal();
            });

            quantityCell.addEventListener('blur', function() {
                const value = parseNumber(this.textContent);
                this.textContent = value > 0 ? value : 1;
                calculateRowTotal(row);
                calculateGrandTotal();
            });
        }

        if (priceCell) {
            priceCell.addEventListener('input', function() {
                calculateRowTotal(row);
                calculateGrandTotal();
            });

            priceCell.addEventListener('blur', function() {
                const value = parseNumber(this.textContent);
                this.textContent = formatNumber(value);
                calculateRowTotal(row);
                calculateGrandTotal();
            });

            priceCell.addEventListener('focus', function() {
                const value = parseNumber(this.textContent);
                this.textContent = value;
            });
        }
    }

    // ==================== SAVE & LOAD ====================

    function saveTemplate() {
        const templateData = {
            primaryColor: document.getElementById('primary-color').value,
            secondaryColor: document.getElementById('purple-color').value,
            fontFamily: document.getElementById('font-family').value,
            companyName: document.getElementById('template-company').textContent,
            subtitle: document.getElementById('template-subtitle').textContent,
            contactPhone: document.getElementById('contact-phone').textContent,
            contactEmail: document.getElementById('contact-email').textContent,
            contactCity: document.getElementById('contact-city').textContent,
            clienteNombre: document.getElementById('cliente-nombre').textContent,
            clienteNit: document.getElementById('cliente-nit').textContent,
            projectDescription: document.getElementById('project-description').textContent,
            paymentName: document.getElementById('payment-name').textContent,
            paymentId: document.getElementById('payment-id').textContent,
            paymentAccount: document.getElementById('payment-account').textContent,
            noteText: document.getElementById('note-text').textContent,
            services: []
        };

        document.querySelectorAll('#services-tbody tr').forEach((row, index) => {
            const cells = row.querySelectorAll('td');
            if (cells.length >= 5) {
                templateData.services.push({
                    description: cells[1].textContent,
                    quantity: cells[2].textContent,
                    price: cells[3].textContent
                });
            }
        });

        localStorage.setItem('customTemplate', JSON.stringify(templateData));

        Swal.fire({
            icon: 'success',
            title: 'Plantilla Guardada',
            text: 'Tu plantilla personalizada ha sido guardada correctamente',
            timer: 2000,
            showConfirmButton: false
        });
    }

    function resetTemplate() {
        document.getElementById('primary-color').value = '#262627';
        document.getElementById('purple-color').value = '#9B7FB8';
        document.getElementById('font-family').value = '-apple-system, BlinkMacSystemFont, \'Segoe UI\', sans-serif';
        document.getElementById('template-company').textContent = 'COBRAFLOW';
        document.getElementById('template-subtitle').textContent = 'CUENTA DE COBRO';
        document.getElementById('contact-phone').textContent = '+57 300 123 4567';
        document.getElementById('contact-email').textContent = 'contacto@cobraflow.co';
        document.getElementById('contact-city').textContent = 'Cartagena, Colombia';
        document.getElementById('cliente-nombre').textContent = 'Empresa Cliente S.A.S';
        document.getElementById('cliente-nit').textContent = '900123456-7';
        document.getElementById('project-description').textContent = 'Consultor√≠a y desarrollo de software empresarial';
        document.getElementById('payment-name').textContent = 'Juan P√©rez';
        document.getElementById('payment-id').textContent = '1234567890';
        document.getElementById('payment-account').textContent = 'Bancolombia - Ahorro - 12345678901';
        document.getElementById('note-text').textContent = 'Se solicita que el pago sea realizado a la mayor brevedad posible.';

        const tbody = document.getElementById('services-tbody');
        tbody.innerHTML = `
            <tr>
                <td style="text-align: center;"><a class="service-remove" onclick="removeServiceRow(this)">‚úñ</a></td>
                <td contenteditable="true" data-placeholder="Descripci√≥n del servicio">Consultor√≠a Empresarial</td>
                <td style="text-align: center;" contenteditable="true" class="quantity-cell" data-placeholder="1">1</td>
                <td style="text-align: right;" contenteditable="true" class="price-cell" data-prefix="$" data-placeholder="0">3,590,000</td>
                <td style="text-align: right;" class="total-cell"><span data-prefix>$</span><span class="row-total">3,590,000</span></td>
            </tr>
        `;

        initializeTable();
        applyColors();
        applyFont();
    }

    function downloadPDF() {
        window.print();
    }

    // ==================== INITIALIZATION ====================

    function initializeTable() {
        const rows = document.querySelectorAll('#services-tbody tr');
        rows.forEach(row => {
            attachCellListeners(row);
            calculateRowTotal(row);
        });
        calculateGrandTotal();
    }

    // Prevenir Enter en campos editables
    document.addEventListener('keydown', function(e) {
        if (e.target.matches('[contenteditable]') && e.key === 'Enter') {
            e.preventDefault();
            e.target.blur();
        }
    });

    window.addEventListener('DOMContentLoaded', function() {
        // Establecer fecha actual
        const now = new Date();
        const dateStr = `${now.getDate().toString().padStart(2, '0')}/${(now.getMonth() + 1).toString().padStart(2, '0')}/${now.getFullYear()}`;
        document.getElementById('doc-date').textContent = dateStr;

        // Cargar plantilla guardada
        const savedTemplate = localStorage.getItem('customTemplate');
        if (savedTemplate) {
            try {
                const data = JSON.parse(savedTemplate);

                document.getElementById('primary-color').value = data.primaryColor || '#262627';
                document.getElementById('purple-color').value = data.secondaryColor || data.purpleColor || '#9B7FB8';
                document.getElementById('font-family').value = data.fontFamily || '-apple-system, BlinkMacSystemFont, \'Segoe UI\', sans-serif';
                document.getElementById('template-company').textContent = data.companyName || 'COBRAFLOW';
                document.getElementById('template-subtitle').textContent = data.subtitle || 'CUENTA DE COBRO';
                document.getElementById('contact-phone').textContent = data.contactPhone || '';
                document.getElementById('contact-email').textContent = data.contactEmail || '';
                document.getElementById('contact-city').textContent = data.contactCity || '';
                document.getElementById('cliente-nombre').textContent = data.clienteNombre || '';
                document.getElementById('cliente-nit').textContent = data.clienteNit || '';
                document.getElementById('project-description').textContent = data.projectDescription || '';
                document.getElementById('payment-name').textContent = data.paymentName || '';
                document.getElementById('payment-id').textContent = data.paymentId || '';
                document.getElementById('payment-account').textContent = data.paymentAccount || '';
                document.getElementById('note-text').textContent = data.noteText || '';

                if (data.services && data.services.length > 0) {
                    const tbody = document.getElementById('services-tbody');
                    tbody.innerHTML = '';

                    data.services.forEach(service => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td style="text-align: center;"><a class="service-remove" onclick="removeServiceRow(this)">‚úñ</a></td>
                            <td contenteditable="true" data-placeholder="Descripci√≥n del servicio">${service.description || ''}</td>
                            <td style="text-align: center;" contenteditable="true" class="quantity-cell" data-placeholder="1">${service.quantity || 1}</td>
                            <td style="text-align: right;" contenteditable="true" class="price-cell" data-prefix="$" data-placeholder="0">${service.price || 0}</td>
                            <td style="text-align: right;" class="total-cell"><span data-prefix>$</span><span class="row-total">0</span></td>
                        `;
                        tbody.appendChild(row);
                    });
                }
            } catch (e) {
                console.error('Error loading template:', e);
            }
        }

        initializeTable();
        applyColors();
        applyFont();

        document.getElementById('primary-color').addEventListener('input', applyColors);
        document.getElementById('purple-color').addEventListener('input', applyColors);

        // Verificar si es la primera vez que el usuario visita
        const hasSeenTour = localStorage.getItem('hasSeenEditorTour');
        if (!hasSeenTour) {
            setTimeout(() => {
                startTour();
                localStorage.setItem('hasSeenEditorTour', 'true');
            }, 500);
        }
    });

    // ==================== INTRO.JS TOUR ====================

    function startTour() {
        introJs().setOptions({
            steps: [
                {
                    element: document.querySelector('.controls-panel'),
                    intro: "üé® <strong>Panel de Controles</strong><br>Aqu√≠ puedes personalizar los colores de tu plantilla y gestionar los servicios. Todos los cambios se aplican en tiempo real.",
                    position: 'right'
                },
                {
                    element: document.querySelector('.template-preview'),
                    intro: "üìÑ <strong>Vista Previa del Documento</strong><br>Este es tu documento de cuenta de cobro. Puedes hacer clic en cualquier texto para editarlo directamente.",
                    position: 'left'
                },
                {
                    element: document.getElementById('cliente-nombre'),
                    intro: "‚úèÔ∏è <strong>Campos Editables</strong><br>Los campos como este son editables. Haz clic sobre ellos para cambiar el contenido. Ver√°s un efecto visual cuando pases el mouse.",
                    position: 'top'
                },
                {
                    element: document.getElementById('template-table'),
                    intro: "üìä <strong>Tabla de Servicios</strong><br>En esta tabla puedes agregar, editar o eliminar servicios. Los totales se calculan autom√°ticamente al modificar cantidad o precio.",
                    position: 'top'
                },
                {
                    element: document.getElementById('add-service-btn'),
                    intro: "‚ûï <strong>Agregar Servicios</strong><br>Usa este bot√≥n para agregar m√°s servicios a tu cuenta de cobro. Puedes agregar tantos como necesites y cada uno se calcular√° autom√°ticamente.",
                    position: 'right'
                },
                {
                    intro: "‚úÖ <strong>¬°Listo!</strong><br>Ya puedes empezar a personalizar tu cuenta de cobro. Usa el bot√≥n '‚ùì Tour Guiado' en cualquier momento para volver a ver esta gu√≠a."
                }
            ],
            nextLabel: 'Siguiente',
            prevLabel: 'Anterior',
            doneLabel: 'Finalizar',
            skipLabel: 'Saltar',
            showProgress: true,
            showBullets: false,
            exitOnOverlayClick: false,
            scrollToElement: true,
            overlayOpacity: 0.7,
            tooltipClass: 'customTooltip'
        }).start();
    }
</script>

<!-- Intro.js JavaScript -->
<script src="https://unpkg.com/intro.js/intro.js"></script>

<style>
    /* Personalizaci√≥n de Intro.js */
    .introjs-tooltip {
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        min-width: 350px;
        max-width: 450px;
    }

    .introjs-tooltiptext {
        font-size: 15px;
        line-height: 1.6;
        padding: 15px 20px;
    }

    .introjs-button {
        border-radius: 6px;
        padding: 8px 16px;
        font-weight: 600;
        text-shadow: none;
        transition: all 0.2s ease;
    }

    .introjs-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .introjs-nextbutton {
        background: linear-gradient(135deg, #262627 0%, #1a1a1b 100%);
        border: none;
    }

    .introjs-prevbutton {
        background: #e2e8f0;
        color: #2d3748;
        border: none;
    }

    .introjs-skipbutton {
        color: #718096;
    }

    .introjs-progressbar {
        background: linear-gradient(135deg, #262627 0%, #1a1a1b 100%);
    }

    .introjs-helperLayer {
        background: rgba(255, 255, 255, 0.05);
        border: 2px solid #262627;
        box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7), 0 0 20px rgba(38, 38, 39, 0.5);
        border-radius: 8px;
    }

    .introjs-tooltipReferenceLayer * {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
    }
</style>

{% endblock %}
